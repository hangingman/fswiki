# FSWiki DBインポートデバッグログ - 2025-07-24 (要約)

## 概要
FSWikiのdumpファイルをMySQLデータベースにインポートする際に、`PL_current_context` エラーが発生し、`DBD::mysql` モジュールのロードに失敗する問題が継続していたが、最終的に解決した。

## 問題の核心と解決策

### 問題点
`PL_current_context` エラーは、PerlモジュールがコンパイルされたPerlのバージョンと、実行時に使用されるPerlのバージョンがバイナリレベルで互換性がない場合に発生する。`wiki` コンテナでは、`Dockerfile` のベースイメージが `perl:5.38` であるにもかかわらず、`import_to_db.pl` スクリプトが `#!/usr/bin/env perl` のシェバンにより、システムにインストールされている `/usr/bin/perl` (v5.36) を使用しようとしていた。これにより、`perl:5.38` 環境でインストールされた `DBD::mysql` との間に互換性の問題が生じていた。

さらに、`cpm` や `cpanm` のインストールパスが明示的に `/app/local` に指定されていなかったため、モジュールが意図しない場所にインストールされたり、キャッシュされたプリビルドモジュールが使用されたりして、問題が複雑化していた。

### 解決策
1.  **Perlモジュールのインストールパスの統一:**
    `docker/dev/Dockerfile` と `docker/debian/Dockerfile` の両方で、`cpm` および `cpanm` がモジュールを `/app/local` にインストールするように `cpm install -L /app/local` および `cpanm --local-lib=/app/local` を使用するように修正した。これにより、すべてのPerlモジュールが `/app/local` 以下に一貫してインストールされるようになった。

2.  **クリーンな環境での再ビルド:**
    すべてのDockerコンテナと関連ボリュームを削除し、`docker compose up -d --build --no-cache` を実行して、完全にクリーンな状態から再ビルド・再起動した。これにより、`DBD::mysql` が `perl:5.38` 環境で正しくコンパイルされ、`PL_current_context` エラーが解消された。

3.  **`import_to_db.pl` の修正:**
    `import_to_db.pl` の `INSERT` ステートメントを `REPLACE` に変更し、重複エントリによるエラーを回避した。

## 結論

上記修正により、`PL_current_context` エラーは解消され、FSWikiのdumpファイルのMySQLデータベースへのインポートが正常に完了した。
