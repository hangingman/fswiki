# 実装詳細

このドキュメントでは、FSWikiの特定の機能や実装に関する詳細を記述します。

## プラグイン開発

FSWikiは強力なプラグインシステムを備えており、様々な種類のプラグインを開発することで機能を拡張できます。

### プラグインのインストール

プラグインはパッケージごとにディレクトリを作成し、`plugin` ディレクトリに配置します。プラグインを有効にするには管理画面から「プラグインの設定」で該当するプラグインにチェックを入れます。

プラグインを開発する場合、パッケージごとにまとめて `パッケージ名::Install` というモジュールを作成し、そのモジュール内でインストール処理を行うようにします。

```perl
package plugin::test::Install;
sub install {
  my $wiki = shift;
  $wiki->add_inline_plugin("helio","plugin::test::TestPlugin");
}
```

有効になっているパッケージは自動的に `plugin::test::Install` モジュールの `install` メソッドが呼び出され、プラグインのインストールが行われます。

### アクションハンドラ

アクションハンドラプラグインは `action` というリクエストパラメータによってクライアントへのレスポンスを行うプラグインです。アクションハンドラプラグインは `do_action` メソッドを実装したクラスでなくてはなりません。また、戻り値として、表示する内容（HTML）を返すようにします。

```perl
sub do_action {
  my $self = shift;
  my $wiki = shift;
  return "アクションハンドラプラグインからの出力";
}
```

アクションハンドラの登録はインストールスクリプト中で `Wiki#add_handler` メソッドによって行います。

```perl
$wiki->add_handler("EDIT","plugin::core::EditPage");
```

管理者のみ使用可能なアクションハンドラは `Wiki#add_admin_handler` メソッドによって登録します。このメソッドによって登録されたアクションハンドラは管理者としてログインしている場合のみ実行可能になり、それ以外の場合はエラーメッセージを表示します。

```perl
$wiki->add_admin_handler("ADMINPAGE","plugin::admin::AdminPageHandler");
```

### フックプラグイン

フックプラグインはある契機で特定のメソッドを実行するプラグインです。メニューのON/OFF切り替えや、ページ保存時などのタイミングで特殊な処理を行う場合に使用します。フックプラグインは `hook` メソッドを実装したクラスでなくてはなりません。

`hook` メソッドの第３引数には起動されたフックの名前が渡されます。１つのクラスで複数の処理を実装する場合はこの変数を見て処理を分けます。また、第４引数以降には `Wiki#do_hook` メソッド呼び出し時に指定されたパラメータ（呼び出し側に依存）が渡されます。独自にフックを定義してパラメータを渡したい場合に使用してください。

```perl
sub hook {
  my $self   = shift;
  my $wiki   = shift;
  my $name   = shift;
  my @params = @_; 
  ...
}
```

フックプラグインの登録はインストールスクリプト中で `Wiki#add_hook` メソッドによって行います。

```perl
$wiki->add_hook("show","plugin::core::BBS");
```

フックには以下ものが存在します。

*   `show` - ページの表示前に呼ばれます。
*   `save_before` - ページの保存処理前に呼ばれます。
*   `save_after` - ページの保存終了後に呼ばれます（ページ削除時は呼ばれません）。
*   `delete` - ページの削除後に呼ばれます。
*   `create_wiki` - WikiFarmで新しくWikiが作成された場合に呼ばれます。
*   `remove_wiki` - WikiFarmでWikiが削除された場合に呼ばれます。
*   `initialize` - CGIの起動時に呼ばれます。プラグインごとに初期化処理が必要な場合などはこのフックに登録してください。

また、これ以外にプラグインによっては独自にフックを定義している場合があります。

### インラインプラグイン

インラインプラグインはWiki文書中に

```
{{プラグイン名 [引数1,引数2...]}}
```

で埋め込むことで、特殊な出力を行うプラグインです。インラインプラグインは `inline` メソッドを実装したクラスでなくてはなりません。戻り値としてWiki形式の文字列またはHTMLを返すようにします。Wiki形式のテキストを返す場合はPDFにも出力が反映されます。

以下にHTMLを返すプラグインの例を示します。

```perl
sub inline {
  my $self = shift;
  my $wiki = shift;
  return "<b>簡単なプラグインです。</b>";
}
```

以下はWiki形式のテキストを返すプラグインの例です。

```perl
sub inline {
  my $self   = shift;
  my $wiki   = shift;
  my $parser = shift;
  return "[[FrontPage]]";
}
```

インラインプラグインの登録はインストールスクリプト中で `Wiki#add_inline_plugin` メソッドによって行います。第一引数には実際にWikiページを記述する際にプラグインを指定するための文字列、第二引数にはプラグインのクラス名、第三引数にはそのプラグインの返す文字列に応じてHTMLまたはWIKIを指定します。

```perl
$wiki->add_inline_plugin("edit","plugin::core::Edit","HTML");
```

### パラグラフプラグイン

パラグラフプラグインはWiki文書中に

```
{{プラグイン名 [引数1,引数2...]}}
```

で埋め込むことで、特殊な出力を行うプラグインです。インラインプラグインと違って１行にプラグインしか記述できず、Pタグの補完も行われません。テーブルやフォーム、リストなどを出力するプラグインをパラグラフプラグインとして実装します。パラグラフプラグインは `paragraph` メソッドを実装したクラスでなくてはなりません。

`paragraph` メソッドは実装方法自体はインラインプラグインと同様です。以下にHTMLを返す場合の例を示します。Pタグは補完されないので必要に応じてプラグイン側でつけてやる必要があります。

```perl
sub paragraph {
  my $self = shift;
  my $wiki = shift;
  return "<p>パラグラフプラグインです。</p>";
}
```

以下はWiki形式のテキストを返す場合の例です。

```perl
sub paragraph {
  my $self   = shift;
  my $wiki   = shift;
  return "*[[FrontPage]]\n*[[Help]]\n";
}
```

パラグラフプラグインの登録はインストールスクリプト中で `Wiki#add_paragraph_plugin` メソッドによって行います。第一引数には実際にWikiページを記述する際にプラグインを指定するための文字列、第二引数にはプラグインのクラス名、第三引数にはそのプラグインの返す文字列に応じてHTMLまたはWIKIを指定します。

```perl
$wiki->add_paragraph_plugin("bbs","plugin::bbs::BBS","HTML");
```

### ブロックプラグイン

ブロックプラグインは複数行の引数を取ることができるパラグラフプラグインです。以下のようにして使用します。引数3の部分は複数行に渡って記述することができます。

```
{{プラグイン名 引数1,引数2,
引数3
}}
```

ブロックプラグインでは `paragraph()` メソッドの代わりに `block()` メソッドを実装します。複数行の引数が第一引数として、それ以外の引数は第二引数以降に渡されてきます。

```perl
sub block {
  my $self = shift;
  my $wiki = shift;
  my $text = shift;
  return "<p>".Util::escapeHTML($text)."</p>";
}
```

パラグラフプラグインの登録はインストールスクリプト中で `Wiki#add_block_plugin` メソッドによって行います。第一引数には実際にWikiページを記述する際にプラグインを指定するための文字列、第二引数にはプラグインのクラス名、第三引数にはそのプラグインの返す文字列に応じてHTMLまたはWIKIを指定します。

```perl
$wiki->add_block_plugin("pre","plugin::core::PRE","HTML");
```

### エディットフォームプラグイン

エディットフォームプラグインはページの編集画面に表示されるプラグインです。エディットフォームプラグインは `editform` メソッドを実装したクラスでなくてはなりません。`editform` メソッドは編集画面に表示するHTMLを返却するよう実装します。

エディットフォームプラグインの登録はインストールスクリプト中で `Wiki#add_editform_plugin` メソッドによって行います。

```perl
$wiki->add_editform_plugin("plugin::core::EditHelper",0);
```

第３引数にはそのプラグインの表示優先度を指定します。この値が大きいほど上位に表示されます。

### フォーマットプラグイン

フォーマットプラグインはFSWiki以外のWikiの書式での編集を行なうためのプラグインです。フォーマットプラグインは以下のメソッドを実装していなくてはいけません。

*   `convert_from_fswiki` メソッド - FSWikiから各フォーマットへの変換
*   `convert_from_fswiki_line` メソッド - FSWikiから各フォーマットへの変換（インライン要素のみ）
*   `convert_to_fswiki` メソッド - 各フォーマットからFSWiki形式への変換
*   `convert_to_fswiki_line` メソッド - 各フォーマットからFSWiki形式への変換（インライン要素のみ）

フォーマットプラグインはインストールスクリプト中で以下のようにして登録を行ないます。

```perl
$wiki->add_format_plugin("Hiki","plugin::format::HikiFormat");
```

### メニューアイテム

Wikiオブジェクトの `add_menu` メソッドで画面上部のメニューアイテムを追加することができます。

```perl
$wiki->add_menu(名称,URL,優先度);
```

第３引数にはそのプラグインの表示優先度を指定します。この値が大きいほど左側に表示されます。また、URLを省略するか、空文字列を設定すると無効なメニューが登録されます。既に同じ名前のアイテムが登録されていた場合は上書きされます。

### 管理者メニュー

Wikiオブジェクトの `add_admin_menu` メソッドで管理者ログイン時のメニューを追加することができます。このメニューが表示されるのは管理者がログインした場合のみです。一般ユーザがログインしても表示されません。また、管理者メニューから呼び出されるアクションハンドラは `add_admin_handler` で登録しておくとログインチェック、権限チェックが自動化されます。

```perl
$wiki->add_admin_menu(名称,URL);
```
