### TypeScriptへの移行に関する考察

FreestyleWikiのPerl実装をCloudflare Workers上のTypeScriptに移植するにあたり、サーバーレス環境の特性とTypeScriptのモダンな開発パラダイムを最大限に活用することを考慮します。

#### アーキテクチャのマッピング

- **実行モデル**: PerlのCGIスクリプトモデルから、Cloudflare Workersのイベント駆動型サーバーレスモデルへ移行します。各HTTPリクエストはWorkersの`fetch`イベントハンドラによって処理されます。これにより、リクエストごとに新しいプロセスを起動するオーバーヘッドがなくなり、効率的な処理が可能になります。
- **コード構造**: Perlのモジュール構造は、TypeScriptのモジュール、クラス、関数として再構成します。これにより、コードの再利用性、保守性、テスト容易性を向上させます。
- **データ管理**: Perlでのファイルシステムベースのデータ永続化は、Cloudflareが提供するマネージドサービスであるD1 (SQLite互換データベース), KV (Key-Valueストア), R2 (オブジェクトストレージ) に置き換わります。これにより、スケーラビリティ、耐久性、パフォーマンスが向上し、ファイルシステム管理の複雑さが解消されます。

#### データ永続化

- **Cloudflare D1**: Wikiのページデータ、リビジョン履歴、ユーザー情報、設定データなど、構造化されたデータの永続化にD1を使用します。SQLite互換であるため、既存のデータ構造を比較的容易にマッピングできます。
- **Cloudflare KV**: 頻繁にアクセスされるページコンテンツのレンダリング結果や、一時的なセッション情報、設定値のキャッシュなど、低レイテンシでの読み取りが求められるデータにKVを使用します。
- **Cloudflare R2**: 添付ファイルなどのバイナリデータの保存にR2を使用します。S3互換のAPIを通じてアクセス可能です。

#### ルーティング

Cloudflare Workersでは、Workersスクリプトの`fetch`ハンドラ内で`Request`オブジェクトのURLを解析し、適切な処理ロジックにディスパッチすることでルーティングを実現します。`itty-router`のような軽量なルーティングライブラリを利用するか、自前でURLパスとハンドラ関数をマッピングするロジックを実装します。現在の実装では、自前で`/wiki/:title`形式のURLをルーティングしています。

#### プラグインシステム

FreestyleWikiの大きな特徴であるプラグインシステムは、TypeScriptで再設計・実装が必要です。Perlのプラグインタイプ（アクションハンドラ、フック、インライン、パラグラフ、ブロック、エディットフォーム、フォーマット）に対応するTypeScriptのインターフェースや抽象クラスを定義し、開発者が容易に新しいプラグインを作成・登録できる仕組みを構築します。

- **アクションハンドラ**: 特定のURLパスやクエリパラメータに対応するリクエストハンドラ関数として実装します。
- **フックプラグイン**: 特定のイベント（例: ページ保存前、ページ表示後）発生時に実行される関数として実装します。
- **インライン/パラグラフ/ブロックプラグイン**: Wikiテキストのパース時に特定の記法（例: `{{plugin}}`）を検知し、対応するTypeScript関数を実行してHTMLフラグメントやWikiテキストを生成する形で実装します。
- **エディットフォームプラグイン**: 編集画面のUI要素を生成する関数として実装し、クライアントサイドまたはサーバーサイドレンダリングで組み込みます。
- **フォーマットプラグイン**: 異なるWiki記法間の変換ロジックを持つクラスとして実装します。

#### 主要機能のTypeScriptでの実装

- **テキスト整形ルール**: FreestyleWiki独自のWiki記法を解析し、HTMLに変換するパーサーおよびレンダラーをTypeScriptで実装します。PerlのParserモジュールのロジックを移植します。
- **差分計算ロジック**: ページリビジョン間の差分を計算し、表示するためのロジックをTypeScriptで実装します。
- **認証・認可**: 管理者および一般ユーザーの認証・認可は、D1に保存されたユーザー情報と、セッション管理（KVまたはCookieを使用）を組み合わせて実現します。
- **設定管理**: setup.datによる設定は、D1の専用テーブル、Workersの環境変数、またはKVストアに移行し、TypeScriptコードからアクセスできるようにします。
- **サイトテンプレートとテーマ**: HTML::TemplateやtDiaryテーマの概念は、TypeScriptのテンプレートエンジン（例: EJS, Handlebarsなど）や、WorkersでHTMLを生成するロジックとして再実装します。
- **WikiFarm**: 複数のWikiサイトを管理する機能は、D1のデータベース設計やルーティングロジックに影響します。各Wikiサイトの設定やデータ分離をどのように行うか設計が必要です。

#### Cloudflare Workers環境での考慮事項

- **ステートレス性**: Workersはステートレスであるため、セッション情報や一時的なデータはKVやCookieに保存する必要があります。
- **コールドスタート**: アクセスの少ないWorkersはコールドスタートが発生する可能性があります。重要な処理のレイテンシを考慮する必要があります。
- **リソース制限**: WorkersにはCPU時間やメモリなどの制限があります。重い処理は避けるか、Workers Durable Objectsなどの他のCloudflareサービスを検討します。
- **デプロイ**: `wrangler` CLIを使用して簡単にデプロイできます。CI/CDパイプラインに組み込むことも可能です。

これらの点を踏まえ、FreestyleWikiのTypeScriptへの移植を進めていきます。
