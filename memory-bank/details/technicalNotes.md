### TypeScriptへの移行に関する考察

FreestyleWikiのPerl実装をCloudflare Workers上のTypeScriptに移植するにあたり、サーバーレス環境の特性とTypeScriptのモダンな開発パラダイムを最大限に活用することを考慮します。

#### アーキテクチャのマッピング

- **実行モデル**: PerlのCGIスクリプトモデルから、Cloudflare Workersのイベント駆動型サーバーレスモデルへ移行します。各HTTPリクエストはWorkersの`fetch`イベントハンドラによって処理されます。これにより、リクエストごとに新しいプロセスを起動するオーバーヘッドがなくなり、効率的な処理が可能になります。
- **コード構造**: Perlのモジュール構造は、TypeScriptのモジュール、クラス、関数として再構成します。これにより、コードの再利用性、保守性、テスト容易性を向上させます。
- **データ管理**: Perlでのファイルシステムベースのデータ永続化は、Cloudflareが提供するマネージドサービスであるD1 (SQLite互換データベース), KV (Key-Valueストア), R2 (オブジェクトストレージ) に置き換わります。これにより、スケーラビリティ、耐久性、パフォーマンスが向上し、ファイルシステム管理の複雑さが解消されます。

#### データ永続化

- **Cloudflare D1**: Wikiのページデータ、リビジョン履歴、ユーザー情報、設定データなど、構造化されたデータの永続化にD1を使用します。SQLite互換であるため、既存のデータ構造を比較的容易にマッピングできます。
- **Cloudflare KV**: 頻繁にアクセスされるページコンテンツのレンダリング結果や、一時的なセッション情報、設定値のキャッシュなど、低レイテンシでの読み取りが求められるデータにKVを使用します。
- **Cloudflare R2**: 添付ファイルなどのバイナリデータの保存にR2を使用します。S3互換のAPIを通じてアクセス可能です。

#### ルーティング

Cloudflare Workersでは、Workersスクリプトの`fetch`ハンドラ内で`Request`オブジェクトのURLを解析し、適切な処理ロジックにディスパッチすることでルーティングを実現します。`itty-router`のような軽量なルーティングライブラリを利用するか、自前でURLパスとハンドラ関数をマッピングするロジックを実装します。現在の実装では、自前で`/wiki/:title`形式のURLをルーティングしています。

#### プラグインシステム

FreestyleWikiの大きな特徴であるプラグインシステムは、TypeScriptで再設計・実装が必要です。Perlのプラグインタイプ（アクションハンドラ、フック、インライン、パラグラフ、ブロック、エディットフォーム、フォーマット）に対応するTypeScriptのインターフェースや抽象クラスを定義し、開発者が容易に新しいプラグインを作成・登録できる仕組みを構築します。

- **アクションハンドラ**: 特定のURLパスやクエリパラメータに対応するリクエストハンドラ関数として実装します。
- **フックプラグイン**: 特定のイベント（例: ページ保存前、ページ表示後）発生時に実行される関数として実装します。
- **インライン/パラグラフ/ブロックプラグイン**: Wikiテキストのパース時に特定の記法（例: `{{plugin}}`）を検知し、対応するTypeScript関数を実行してHTMLフラグメントやWikiテキストを生成する形で実装します。
- **エディットフォームプラグイン**: 編集画面のUI要素を生成する関数として実装し、クライアントサイドまたはサーバーサイドレンダリングで組み込みます。
- **フォーマットプラグイン**: 異なるWiki記法間の変換ロジックを持つクラスとして実装します。

#### 主要機能のTypeScriptでの実装

- **テキスト整形ルール**: FreestyleWiki独自のWiki記法を解析し、HTMLに変換するパーサーおよびレンダラーをTypeScriptで実装します。PerlのParserモジュールのロジックを移植します。
- **差分計算ロジック**: ページリビジョン間の差分を計算し、表示するためのロジックをTypeScriptで実装します。
- **認証・認可**: 管理者および一般ユーザーの認証・認可は、D1に保存されたユーザー情報と、セッション管理（KVまたはCookieを使用）を組み合わせて実現します。
- **設定管理**: setup.datによる設定は、D1の専用テーブル、Workersの環境変数、またはKVストアに移行し、TypeScriptコードからアクセスできるようにします。
- **サイトテンプレートとテーマ**: HTML::TemplateやtDiaryテーマの概念は、TypeScriptのテンプレートエンジン（例: EJS, Handlebarsなど）や、WorkersでHTMLを生成するロジックとして再実装します。
- **WikiFarm**: 複数のWikiサイトを管理する機能は、D1のデータベース設計やルーティングロジックに影響します。各Wikiサイトの設定やデータ分離をどのように行うか設計が必要です。

#### Cloudflare Workers環境での考慮事項

- **ステートレス性**: Workersはステートレスであるため、セッション情報や一時的なデータはKVやCookieに保存する必要があります。
- **コールドスタート**: アクセスの少ないWorkersはコールドスタートが発生する可能性があります。重要な処理のレイテンシを考慮する必要があります。
- **リソース制限**: WorkersにはCPU時間やメモリなどの制限があります。重い処理は避けるか、Workers Durable Objectsなどの他のCloudflareサービスを検討します。
- **デプロイ**: `wrangler` CLIを使用して簡単にデプロイできます。CI/CDパイプラインに組み込むことも可能です。

これらの点を踏まえ、FreestyleWikiのTypeScriptへの移植を進めていきます。

## FreestyleWiki Perl API ドキュメント概要

**注意:** 以下のAPIドキュメントはPerl実装のものです。TypeScriptへの移植時には、Perlのスネークケースの関数名（例: `get_page_list`）は、TypeScriptの標準的な命名規則に従いキャメルケース（例: `getPageList`）に変換することが一般的です。

### Wiki::Parser

Wikiフォーマットの文字列をパースし、書式に対応したフックメソッドの呼び出しを行います。Wiki::Parserを継承し、これらのフックメソッドをオーバーライドすることで任意のフォーマットへの変換が可能です。

#### メソッド

- `new`: コンストラクタ。
- `parse`: パース処理を開始します。
- `multi_explanation`: 複数行の説明文を処理します。
- `parse_line`: １行分をパースします。parseメソッドの中から必要に応じて呼び出されます。
- `start_parse`: パースを開始前に呼び出されます。サブクラスで必要な処理がある場合はオーバーライドしてください。
- `end_parse`: パース終了後に呼び出されます。サブクラスで必要な処理がある場合はオーバーライドしてください。
- `url_anchor`: URLアンカにマッチした場合に呼び出されます。サブクラスにて処理を実装します。
- `wiki_anchor`: ページ名アンカにマッチした場合に呼び出されます。サブクラスにて処理を実装します。
- `italic`: イタリックにマッチした場合に呼び出されます。サブクラスにて処理を実装します。
- `bold`: ボールドにマッチした場合に呼び出されます。サブクラスにて処理を実装します。
- `underline`: 下線にマッチした場合に呼び出されます。サブクラスにて処理を実装します。
- `denialline`: 打ち消し線にマッチした場合に呼び出されます。サブクラスにて処理を実装します。
- `plugin`: プラグインにマッチした場合に呼び出されます。サブクラスにて処理を実装します。
- `text`: テキストにマッチした場合に呼び出されます。サブクラスにて処理を実装します。
- `l_list`: 項目にマッチした場合に呼び出されます。サブクラスにて処理を実装します。
- `l_numlist`: 番号付き項目にマッチした場合に呼び出されます。サブクラスにて処理を実装します。
- `l_headline`: 見出しにマッチした場合に呼び出されます。サブクラスにて処理を実装します。
- `l_verbatim`: PREタグにマッチした場合に呼び出されます。サブクラスにて処理を実装します。
- `l_line`: 水平線にマッチした場合に呼び出されます。サブクラスにて処理を実装します。
- `l_text`: 特になにもない行にマッチした場合に呼び出されます。サブクラスにて処理を実装します。
- `l_explanation`: 説明にマッチした場合に呼び出されます。サブクラスにて処理を実装します。
- `l_quotation`: 引用にマッチした場合に呼び出されます。サブクラスにて処理を実装します。
- `l_paragraph`: パラグラフの区切りにマッチした場合に呼び出されます。サブクラスにて処理を実装します。
- `l_table`: テーブルにマッチした場合に呼び出されます。サブクラスにて処理を実装します。
- `l_plugin`: パラグラフプラグインにマッチした場合に呼び出されます。サブクラスにて処理を実装します。
- `l_image`: 画像にマッチした場合に呼び出されます。サブクラスにて処理を実装します。
- `error`: エラーメッセージにマッチした場合に呼び出されます。サブクラスにて処理を実装します。

### Util

FSWiki全体で使用されるユーティリティ関数群を提供するモジュールです。

#### メソッド

- `override_die`: dieとexitのオーバライド操作を行います。
- `url_encode`: 引数で渡された文字列をURLエンコードして返します。
- `url_decode`: 引数で渡された文字列をURLデコードして返します。
- `cookie_path`: Cookieのpathに指定する文字列を取得します。
- `make_filename`: ディレクトリ、ファイル名、拡張子を結合してファイル名を生成します。
- `escapeHTML`: 引数で渡された文字列のHTMLタグをエスケープして返します。
- `format_date`: 日付を"yyyy年mm月dd日 hh時mi分ss秒"形式にフォーマットします。
- `trim`: 文字列の両端の空白を切り落とします。
- `delete_tag`: タグを削除して文字列のみを取得します。
- `check_numeric`: 数値かどうかチェックします。数値の場合は真、そうでない場合は偽を返します。
- `send_mail`: 管理者にメールを送信します。
- `handyphone`: クライアントが携帯電話かどうかチェックします。
- `load_config_hash`: 設定ファイルを格納するディレクトリから指定したファイルを読み込み、ハッシュリファレンスとして取得します。
- `load_config_text`: 設定ファイルを格納するディレクトリから指定したファイルを読み込み、ファイル内容を文字列として取得します。
- `save_config_hash`: 引数で渡したハッシュリファレンスを設定ファイルを格納するディレクトリに指定したファイル名で保存します。
- `save_config_text`: 引数で渡したテキストを設定ファイルを格納するディレクトリに指定したファイル名で保存します。
- `sync_update_config`: 設定ファイルの読み込みと書き込みを同一のロック内で行うための関数。
- `file_lock`: 引数で渡したファイルをロックします。
- `file_unlock`: 引数で渡したファイルのロックを解除します。
- `inline_error`: インラインプラグインからエラーメッセージを返す場合に使用してください。
- `paragraph_error`: パラグラフプラグインからエラーメッセージを返す場合に使用してください。
- `get_response`: 指定のURLにGETリクエストを発行し、レスポンスのボディ部を返却します。
- `get_module_file`: モジュール名からファイル名を取得します。
- `debug`: デバッグログ（debug.log）をカレントディレクトリに出力します。
- `md5`: Digest::Perl::MD5を用いたパスワードの暗号化を行います。
- `make_content_disposition`: HTTPヘッダのContent-Disposition行を生成します。
- `restore_die`: dieとexitのオーバライド操作を解除します。

### Wiki

Wiki API

#### メソッド

- `new`: コンストラクタ
- `add_user`: ユーザを追加します
- `user_exists`: ユーザが存在するかどうかを確認します
- `get_login_info`: ログイン情報を取得します。
- `login_check`: ログインチェックを行います。
- `add_editform_plugin`: エディットフォームプラグインを追加します
- `get_editform_plugin`: 編集フォーム用のプラグインの出力を取得します
- `add_admin_menu`: 管理者用のメニューを追加します。
- `add_user_menu`: ログインユーザ用のメニューを追加します。
- `get_admin_menu`: 管理者用のメニューを取得します。
- `install_plugin`: プラグインをインストールします。
- `is_installed`: プラグインがインストールされているかどうかを調べます。
- `add_menu`: メニュー項目を追加します。
- `add_hook`: フックプラグインを登録します。
- `do_hook`: add_hookメソッドで登録されたフックプラグインを実行します。
- `add_handler`: アクションハンドラプラグインを追加します。
- `add_user_handler`: ログインユーザ用のアクションハンドラを追加します。
- `add_admin_handler`: 管理者用のアクションハンドラを追加します。
- `add_plugin`: インラインプラグインを追加します。
- `add_inline_plugin`: インラインプラグインを登録します。
- `add_paragraph_plugin`: パラグラフプラグインを登録します。
- `add_block_plugin`: ブロックプラグインを登録します。
- `get_plugin_info`: プラグインの情報を取得します
- `call_handler`: add_handlerメソッドで登録されたアクションハンドラを実行します。
- `process_wiki`: 引数で渡したWikiフォーマットの文字列をHTMLに変換して返します。
- `process_plugin`: インラインプラグイン、パラグラフプラグインの呼び出し（内部処理用の関数）。
- `get_current_parser`: パース中の場合、現在有効なWiki::Parserのインスタンスを返却します。
- `error`: エラーの場合、呼び出します。
- `get_plugin_instance`: プラグインのインスタンスを取得します。
- `parse_inline_plugin`: インラインプラグインをパースしてコマンドと引数に分割します。
- `add_format_plugin`: フォーマットプラグインを追加します。
- `get_format_names`: インストールされているフォーマットプラグインの一覧を取得します。
- `convert_to_fswiki`: 各Wiki書式で記述したソースをFSWikiの書式に変換します。
- `convert_from_fswiki`: FSWikiの書式で記述したソースを各Wikiの書式に変換します。
- `get_edit_format`: 現在のユーザが編集に使用するフォーマットを取得します。
- `add_head_info`: headタグ内に出力する情報を追加します。
- `freeze_page`: ページを凍結します
- `un_freeze_page`: ページの凍結を解除します
- `get_freeze_list`: 凍結されているページのリストを取得します。
- `is_freeze`: 引数で渡したページが凍結中かどうかしらべます
- `can_modify_page`: 引数で渡したページが編集可能かどうかを調べます。
- `set_page_level`: ページの参照レベルを設定します。
- `get_page_level`: ページの参照レベルを取得します。
- `can_show`: ページが参照可能かどうかを取得します。
- `create_page_url`: ページにジャンプするためのURLを生成するユーティリティメソッドです。
- `create_url`: 任意のURLを生成するためのユーティリティメソッドです。
- `set_title`: アクションハンドラ中でタイトルを設定する場合に使用します。
- `get_title`: タイトルを取得します。
- `get_page_list`: ページの一覧を取得します。
- `get_last_modified`: ページの物理的な（データファイルの更新日時）最終更新時刻を取得します。
- `get_last_modified2`: ページ論理的な最終更新時刻を取得します。
- `get_page`: ページのソースを取得します。
- `get_backup`: バックアップされたソースを取得します。
- `save_page`: ページを保存します。
- `page_exists`: ページが存在するかどうか調べます。
- `get_CGI`: CGIオブジェクトを取得
- `redirect`: 引数で渡したページにリダイレクトします。
- `redirectURL`: 指定のURLにリダイレクトします。
- `config`: グローバル設定を取得もしくは変更します
- `farm_is_enable`: Farm機能が有効になっているかどうかを取得します。
- `create_wiki`: 子Wikiを作成します。
- `remove_wiki`: 子Wikiを削除します。
- `wiki_exists`: 引数で渡した名称の子Wikiが存在するかどうかを調べます。
- `get_wiki_list`: 子Wikiを配列で取得します。
- `search_child`: 子Wikiのツリーを配列で取得します。
